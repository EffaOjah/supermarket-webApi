<!DOCTYPE html>
<html>
  <head>
    <title>Create Invoice</title>
    <meta
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no"
      name="viewport"
    />
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
    />
    <script
      src="https://kit.fontawesome.com/a207e207d8.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="/css/ready.css" />
    <link rel="stylesheet" href="/css/demo.css" />
    <link rel="stylesheet" href="/iziToast-master/dist/css/iziToast.min.css" />
    <style>
      .item-row {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #eee;
        margin-bottom: 10px;
        transition: all 0.3s;
      }
      .item-row:hover {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .remove-btn {
        color: #dc3545;
        cursor: pointer;
        transition: color 0.2s;
      }
      .remove-btn:hover {
        color: #a71d2a;
      }
      .total-display {
        font-size: 1.2rem;
        font-weight: bold;
        color: #28a745;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="main-header">
			<div class="logo-header">
				<a href="/admin/dashboard" class="logo">
					MaryBill Conglomerate
				</a>
				<button class="navbar-toggler sidenav-toggler ml-auto" type="button" data-toggle="collapse"
					data-target="collapse" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<button class="topbar-toggler more"><i class="la la-ellipsis-v"></i></button>
			</div>
			<nav class="navbar navbar-header navbar-expand-lg">
				<div class="container-fluid">

					<form class="navbar-left navbar-form nav-search mr-md-3" action="">
						<div class="input-group">
							<input type="text" placeholder="Search ..." class="form-control">
							<div class="input-group-append">
								<span class="input-group-text">
									<i class="la la-search search-icon"></i>
								</span>
							</div>
						</div>
					</form>
					<ul class="navbar-nav topbar-nav ml-md-auto align-items-center">
						<li class="nav-item dropdown hidden-caret">
							<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown"
								aria-haspopup="true" aria-expanded="false">
								<i class="la la-envelope"></i>
							</a>
							<!-- <div class="dropdown-menu" aria-labelledby="navbarDropdown">
								<a class="dropdown-item" href="#">Action</a>
								<a class="dropdown-item" href="#">Another action</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#">Something else here</a>
							</div> -->
						</li>
						<!-- <li class="nav-item dropdown hidden-caret">
							<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown"
								aria-haspopup="true" aria-expanded="false">
								<i class="la la-bell"></i>
								<span class="notification"></span>
							</a>
							<ul class="dropdown-menu notif-box" aria-labelledby="navbarDropdown">
								<li>
									<div class="dropdown-title">You have 4 new notification</div>
								</li>
								<li>
									<div class="notif-center">
										<a href="#">
											<div class="notif-icon notif-primary"> <i class="la la-user-plus"></i>
											</div>
											<div class="notif-content">
												<span class="block">
													New user registered
												</span>
												<span class="time">5 minutes ago</span>
											</div>
										</a>
										<a href="#">
											<div class="notif-icon notif-success"> <i class="la la-comment"></i> </div>
											<div class="notif-content">
												<span class="block">
													Rahmad commented on Admin
												</span>
												<span class="time">12 minutes ago</span>
											</div>
										</a>
										<a href="#">
											<div class="notif-img">
												<img src="/img/profile2.jpg" alt="Img Profile">
											</div>
											<div class="notif-content">
												<span class="block">
													Reza send messages to you
												</span>
												<span class="time">12 minutes ago</span>
											</div>
										</a>
										<a href="#">
											<div class="notif-icon notif-danger"> <i class="la la-heart"></i> </div>
											<div class="notif-content">
												<span class="block">
													Farrah liked Admin
												</span>
												<span class="time">17 minutes ago</span>
											</div>
										</a>
									</div>
								</li>
								<li>
									<a class="see-all" href="javascript:void(0);"> <strong>See all
											notifications</strong> <i class="la la-angle-right"></i> </a>
								</li>
							</ul>
						</li> -->
						<li class="nav-item dropdown">
							<a class="dropdown-toggle profile-pic" data-toggle="dropdown" href="#" aria-expanded="false"> <img
									src="/img/profile-icon.png" alt="user-img" width="36" class="img-circle"><span>Steven</span></span>
							</a>
							<ul class="dropdown-menu dropdown-user">
								<li>
									<div class="user-box">
										<div class="u-img"><img src="/img/profile-icon.png" alt="user"></div>
										<div class="u-text">
											<h4>Steven</h4>
											<p class="text-muted">hello@themekita.com</p><a href="#"
												class="btn btn-rounded btn-danger btn-sm">View Profile</a>
										</div>
									</div>
								</li>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#"><i class="ti-user"></i> My Profile</a>
								<a class="dropdown-item" href="#"></i> My Balance</a>
								<a class="dropdown-item" href="#"><i class="ti-email"></i> Inbox</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#"><i class="ti-settings"></i> Account Setting</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#"><i class="fa fa-power-off"></i> Logout</a>
							</ul>
							<!-- /.dropdown-user -->
						</li>
					</ul>
				</div>
			</nav>
		</div>
		<!-- Sidebar -->
		<!-- Sidebar -->
        <% if (user && user.role === 'accountant') { %>
            <%- include('../partials/accountant-sidebar') %>
        <% } else { %>
            <%- include('../partials/sidebar') %>
        <% } %>
		<!-- End Sidebar -->
		<!-- End Sidebar -->

      <div class="main-panel">
        <div class="content">
          <div class="container-fluid">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h4 class="page-title mb-0">Create New Invoice</h4>
              <a href="/invoices" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
              </a>
            </div>

            <div class="card shadow-sm">
              <div class="card-body">
                <form action="/invoices/create" method="POST" id="invoiceForm">
                  <h5 class="text-primary mb-3">
                    <i class="fas fa-user"></i> Customer Details
                  </h5>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label
                          >Select Customer
                          <span class="text-danger">*</span></label
                        >
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text"
                              ><i class="fas fa-user-circle"></i
                            ></span>
                          </div>
                          <select
                            name="customerId"
                            class="form-control"
                            required
                          >
                            <option value="">-- Choose Customer --</option>
                            <% customers.forEach(customer => { %>
                            <option value="<%= customer.customer_id %>">
                              <%= customer.name %> (Bal: <%=
                              customer.account_balance %>)
                            </option>
                            <% }) %>
                          </select>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                        <label
                          >Invoice Date
                          <span class="text-danger">*</span></label
                        >
                        <input
                          type="date"
                          name="invoiceDate"
                          class="form-control"
                          required
                          value="<%= new Date().toISOString().split('T')[0] %>"
                        />
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                        <label>Due Date</label>
                        <input
                          type="date"
                          name="dueDate"
                          class="form-control"
                        />
                      </div>
                    </div>
                  </div>

                  <hr class="my-4" />

                  <div
                    class="d-flex align-items-center justify-content-between mb-3"
                  >
                    <h5 class="text-primary mb-0">
                      <i class="fas fa-shopping-cart"></i> Invoice Items
                    </h5>
                    <button
                      type="button"
                      class="btn btn-sm btn-primary"
                      onclick="addItem()"
                    >
                      <i class="fas fa-plus"></i> Add Item
                    </button>
                  </div>

                  <div id="itemsContainer">
                    <!-- Items will be rendered here -->
                  </div>

                  <hr class="my-4" />

                  <div class="row justify-content-end">
                    <div class="col-md-4 text-right">
                      <h5 class="mb-3">Grand Total</h5>
                      <div class="total-display">
                        ₦ <span id="grandTotal">0.00</span>
                      </div>
                    </div>
                  </div>

                  <input type="hidden" name="items" id="itemsInput" />

                  <div class="mt-4 text-right">
                    <button type="submit" class="btn btn-success btn-lg px-5">
                      <i class="fas fa-check-circle"></i> Create Invoice
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let items = [];

      function renderItems() {
        const container = document.getElementById("itemsContainer");
        container.innerHTML = "";

        if (items.length === 0) {
          container.innerHTML =
            '<div class="text-center text-muted py-3">No items added. Click "Add Item" to start.</div>';
          updateGrandTotal();
          updateInput();
          return;
        }

        items.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "item-row";
          div.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <span class="badge badge-light text-muted">#${
                              index + 1
                            }</span>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group p-0">
                                <input type="text" class="form-control" placeholder="Item Description" 
                                    value="${item.description}" 
                                    oninput="updateItem(${index}, 'description', this.value)">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group p-0">
                                <div class="input-group">
                                    <input type="number" class="form-control" placeholder="Qty" 
                                        value="${item.quantity}" min="1"
                                        oninput="updateItem(${index}, 'quantity', this.value)">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group p-0">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">₦</span>
                                    </div>
                                    <input type="number" class="form-control" placeholder="Price" 
                                        value="${item.unitPrice}" step="0.01"
                                        oninput="updateItem(${index}, 'unitPrice', this.value)">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-1 text-right">
                            <i class="fas fa-trash-alt remove-btn" onclick="removeItem(${index})" title="Remove Item"></i>
                        </div>
                    </div>
                    <div class="row mt-2">
                            <div class="col-md-12 text-right">
                            <small class="text-muted">Subtotal: ₦ <strong id="subtotal-${index}">${item.total.toLocaleString(
            "en-US",
            { minimumFractionDigits: 2, maximumFractionDigits: 2 }
          )}</strong></small>
                            </div>
                    </div>
                `;
          container.appendChild(div);
        });
        updateGrandTotal();
        updateInput();
      }

      function addItem() {
        items.push({ description: "", quantity: 1, unitPrice: 0, total: 0 });
        renderItems();
      }

      function removeItem(index) {
        items.splice(index, 1);
        renderItems();
      }

      function updateItem(index, field, value) {
        items[index][field] = value;

        if (field === "quantity" || field === "unitPrice") {
          const qty = parseFloat(items[index].quantity) || 0;
          const price = parseFloat(items[index].unitPrice) || 0;
          items[index].total = qty * price;

          // Update specific subtotal element
          const subEl = document.getElementById(`subtotal-${index}`);
          if (subEl)
            subEl.innerText = items[index].total.toLocaleString("en-US", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });

          updateGrandTotal();
        }
        updateInput();
      }

      function updateGrandTotal() {
        const total = items.reduce((sum, item) => sum + item.total, 0);
        document.getElementById("grandTotal").innerText = total.toLocaleString(
          "en-US",
          { minimumFractionDigits: 2, maximumFractionDigits: 2 }
        );
      }

      function updateInput() {
        document.getElementById("itemsInput").value = JSON.stringify(items);
      }

      // Initialize
      addItem();

      // Form Validation
      document.getElementById('invoiceForm').addEventListener('submit', function(e) {
        const customerId = document.getElementsByName('customerId')[0].value;
        const invoiceDate = document.getElementsByName('invoiceDate')[0].value;
        
        if (!customerId) {
            e.preventDefault();
            iziToast.error({
                title: 'Error',
                message: 'Please select a customer',
                position: 'topRight'
            });
            return;
        }

        if (!invoiceDate) {
            e.preventDefault();
            iziToast.error({
                title: 'Error',
                message: 'Please select an invoice date',
                position: 'topRight'
            });
            return;
        }

        if (items.length === 0) {
            e.preventDefault();
            iziToast.error({
                title: 'Error',
                message: 'Please add at least one item to the invoice',
                position: 'topRight'
            });
            return;
        }

        for (let i = 0; i < items.length; i++) {
            if (!items[i].description.trim()) {
                e.preventDefault();
                iziToast.error({
                    title: 'Error',
                    message: `Item #${i + 1} description cannot be empty`,
                    position: 'topRight'
                });
                return;
            }
            if (items[i].quantity <= 0) {
                e.preventDefault();
                iziToast.error({
                    title: 'Error',
                    message: `Item #${i + 1} quantity must be greater than 0`,
                    position: 'topRight'
                });
                return;
            }
            if (items[i].unitPrice < 0) { // allow 0 price? maybe free item.
                e.preventDefault();
                iziToast.error({
                    title: 'Error',
                    message: `Item #${i + 1} price cannot be negative`,
                    position: 'topRight'
                });
                return;
            }
        }
      });
    </script>

    <script src="/js/core/jquery.3.2.1.min.js"></script>
    <script src="/js/core/popper.min.js"></script>
    <script src="/js/core/bootstrap.min.js"></script>
    <script src="/iziToast-master/dist/js/iziToast.min.js"></script>
    <script src="/js/ready.min.js"></script>
    <script src="/js/toast.js"></script>
  </body>
</html>
